<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="釜山之旅">
    
    <title>釜山醫美之旅 Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.12.0/dist/cdn.min.js"></script>
    <style>
        /* 隱藏滾動條 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        body {
            background-color: #f3f4f6;
            background-image: url('https://images.unsplash.com/photo-1596492789966-261d7b67b66c?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        
        .app-container {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            min-height: 100vh;
            padding-bottom: 90px;
        }

        /* 避免 Alpine 載入前畫面閃爍 */
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="text-gray-800 font-sans antialiased" x-data="travelApp()" x-init="isAppLoaded = true">

    <div x-show="!isAppLoaded" class="fixed inset-0 bg-white z-[999] flex items-center justify-center" x-transition:leave.duration.500ms>
        <div class="text-center">
            <i class="fa-solid fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
            <p>正在載入行程...</p>
        </div>
    </div>

    <div class="app-container max-w-md mx-auto shadow-2xl relative overflow-hidden" x-cloak>
        
        <template x-if="currentTab === 'itinerary'">
            <div class="bg-blue-600 text-white p-5 rounded-b-3xl shadow-lg relative z-10">
                <div class="flex justify-between items-center mb-4">
                    <h1 class="text-xl font-bold"><i class="fa-solid fa-plane-departure mr-2"></i>釜山醫美之旅</h1>
                    <div class="text-xs bg-blue-500 px-2 py-1 rounded-full">Dec 25-27</div>
                </div>
                <div class="flex items-center bg-white/20 rounded-2xl p-3 backdrop-blur-sm">
                    <div class="text-4xl mr-4"><i class="fa-solid fa-cloud text-gray-200"></i></div>
                    <div>
                        <div class="text-3xl font-bold tracking-tighter" x-text="weather.temp + '°C'"></div>
                        <div class="text-xs opacity-90">體感 <span x-text="weather.feelsLike"></span>°C | 釜山</div>
                    </div>
                </div>
            </div>
        </template>

        <div x-show="currentTab === 'itinerary'" class="p-4 h-full overflow-y-auto no-scrollbar">
            
            <div class="flex space-x-3 overflow-x-auto no-scrollbar mb-6 py-2">
                <template x-for="(day, index) in days" :key="index">
                    <div @click="selectedDayIndex = index" 
                         class="flex-shrink-0 w-16 h-20 rounded-2xl flex flex-col items-center justify-center cursor-pointer transition-all duration-300 shadow-sm border"
                         :class="selectedDayIndex === index ? 'bg-blue-600 text-white border-blue-600 transform scale-105 shadow-md' : 'bg-white text-gray-500 border-gray-200'">
                        <span class="text-xs font-bold uppercase mb-1" x-text="day.weekday"></span>
                        <span class="text-2xl font-bold" x-text="day.date"></span>
                    </div>
                </template>
            </div>

            <div class="space-y-4 pb-20">
                <template x-for="(item, index) in currentDayItinerary" :key="item.id">
                    <div class="relative pl-6 border-l-2 border-dashed border-gray-300 last:border-0">
                        
                        <div class="absolute -left-[9px] top-4 w-4 h-4 rounded-full border-2 border-white shadow-sm z-10"
                             :class="getCategoryColor(item.type)"></div>

                        <div @click="openMap(item.location)" class="bg-white rounded-xl shadow-md p-4 cursor-pointer hover:shadow-lg transition relative group transform transition active:scale-95 border border-gray-100">
                            <div class="flex justify-between items-start">
                                <div class="w-full">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="px-2 py-0.5 rounded text-[10px] font-bold text-white" :class="getCategoryColor(item.type)" x-text="item.type"></span>
                                        <template x-if="item.startTime"><span class="text-sm font-bold text-gray-700" x-text="item.startTime"></span></template>
                                    </div>
                                    <h3 class="font-bold text-lg text-gray-800 leading-tight mb-2" x-text="item.name"></h3>
                                    
                                    <template x-if="item.note">
                                        <div class="mt-2 text-sm text-gray-600 bg-gray-50 p-2 rounded border border-gray-100 whitespace-pre-line">
                                            <span x-text="item.note"></span>
                                        </div>
                                    </template>
                                    
                                    <template x-if="item.alternativeName">
                                        <div class="mt-2 text-xs text-blue-600 bg-blue-50 p-2 rounded border border-blue-100">
                                            <i class="fa-solid fa-shuffle mr-1"></i>
                                            **備案：**<span class="font-bold" x-text="item.alternativeName"></span>
                                            <template x-if="item.alternativeLocation">
                                                (<a @click.stop="openMap(item.alternativeLocation)" href="#" class="underline text-blue-500 hover:text-blue-700">導航</a>)
                                            </template>
                                        </div>
                                    </template>
                                </div>
                                <button @click.stop="editItem(item)" class="text-gray-300 hover:text-blue-500 p-2"><i class="fa-solid fa-pen"></i></button>
                            </div>
                        </div>

                    </div>
                </template>
            </div>
            
            <button @click="openModal('itinerary')" class="fixed bottom-24 right-4 bg-blue-600 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center text-2xl hover:bg-blue-700 active:scale-90 transition z-50">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

        <div x-show="currentTab === 'info'" class="p-4 h-full overflow-y-auto no-scrollbar pb-24">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">旅遊資訊</h2>
            
            <div class="bg-white rounded-xl shadow-md p-4 mb-4 border border-gray-100">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-bold text-gray-700"><i class="fa-solid fa-calculator mr-2 text-green-500"></i>匯率換算</h3>
                    <span class="text-xs text-gray-400">1 TWD ≈ 42 KRW (參考值)</span>
                </div>
                <div class="flex gap-2 items-center">
                    <div class="flex-1">
                        <label class="text-xs text-gray-500 block mb-1">KRW (韓元)</label>
                        <input type="number" x-model="exchange.krw" @input="calculateTWD" class="w-full bg-gray-50 border border-gray-200 rounded p-2 text-lg font-bold outline-none focus:ring-2 focus:ring-blue-300">
                    </div>
                    <i class="fa-solid fa-arrow-right-arrow-left text-gray-400"></i>
                    <div class="flex-1">
                        <label class="text-xs text-gray-500 block mb-1">TWD (台幣)</label>
                        <input type="number" x-model="exchange.twd" @input="calculateKRW" class="w-full bg-gray-50 border border-gray-200 rounded p-2 text-lg font-bold outline-none focus:ring-2 focus:ring-blue-300">
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-5 mb-4 border border-gray-100">
                <h3 class="font-bold text-gray-800 mb-2 pb-2 border-b"><i class="fa-solid fa-bed mr-2 text-indigo-500"></i>住宿資訊</h3>
                <div class="font-bold text-lg text-indigo-900">K-Guesthouse Seomyeon</div>
                <div class="text-sm text-gray-500 mb-3">韓國西面K旅館</div>
                <div class="space-y-2 text-sm text-gray-600">
                    <div><i class="fa-solid fa-phone w-6 text-center text-gray-400"></i> +82 51-123-4567</div>
                    <div><i class="fa-solid fa-location-dot w-6 text-center text-gray-400"></i> 釜山廣域市 釜山鎮區 西面路</div>
                </div>
                <button @click="openMap('K-Guesthouse Seomyeon')" class="mt-4 w-full bg-indigo-50 text-indigo-600 py-2 rounded-lg font-bold text-sm hover:bg-indigo-100 transition">
                    導航至飯店
                </button>
            </div>
            
            <div class="bg-white rounded-xl shadow-md p-5 mb-4 border border-gray-100">
                <h3 class="font-bold text-gray-800 mb-2 pb-2 border-b"><i class="fa-solid fa-list-check mr-2 text-orange-500"></i>必買必吃清單</h3>
                <div class="space-y-3">
                    <template x-for="(item, index) in checkList" :key="index">
                        <label class="flex items-center text-sm cursor-pointer">
                            <input type="checkbox" x-model="item.checked" class="form-checkbox h-5 w-5 text-orange-600 rounded mr-3">
                            <span class="text-gray-700" :class="item.checked ? 'line-through text-gray-400' : 'font-medium'" x-text="item.name"></span>
                            <span class="ml-auto text-xs font-bold px-2 py-0.5 rounded-full" 
                                  :class="item.type === 'Food' ? 'bg-orange-100 text-orange-600' : 'bg-pink-100 text-pink-600'" 
                                  x-text="item.type"></span>
                        </label>
                    </template>
                </div>
            </div>


            <div class="grid grid-cols-2 gap-3">
                <div class="bg-red-50 p-4 rounded-xl border border-red-100 flex items-center shadow-sm">
                    <div class="bg-red-500 text-white w-10 h-10 rounded-full flex items-center justify-center text-xl mr-3"><i class="fa-solid fa-truck-medical"></i></div>
                    <div>
                        <div class="text-xs text-red-800">救護車</div>
                        <div class="text-xl font-black text-red-600">119</div>
                    </div>
                </div>
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 flex items-center shadow-sm">
                    <div class="bg-blue-600 text-white w-10 h-10 rounded-full flex items-center justify-center text-xl mr-3"><i class="fa-solid fa-user-shield"></i></div>
                    <div>
                        <div class="text-xs text-blue-800">報警</div>
                        <div class="text-xl font-black text-blue-600">112</div>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="currentTab === 'shopping'" class="p-4 h-full overflow-y-auto no-scrollbar pb-24">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">購物清單 <span class="text-sm font-normal text-gray-500 ml-2" x-text="'(' + shoppingList.length + ')'"></span></h2>
            
            <div class="grid grid-cols-2 gap-3">
                <template x-for="(item, index) in shoppingList" :key="index">
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100 relative group">
                        <button @click="deleteShoppingItem(index)" class="absolute top-1 right-1 bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs shadow-md z-10"><i class="fa-solid fa-times"></i></button>
                        
                        <div class="h-32 bg-gray-100 overflow-hidden flex items-center justify-center">
                            <template x-if="item.image">
                                <img :src="item.image" class="w-full h-full object-cover">
                            </template>
                            <template x-if="!item.image">
                                <i class="fa-solid fa-bag-shopping text-gray-300 text-3xl"></i>
                            </template>
                        </div>
                        <div class="p-2">
                            <div class="font-bold text-gray-800 truncate text-sm" x-text="item.name"></div>
                        </div>
                    </div>
                </template>
            </div>

            <button @click="openModal('shopping')" class="fixed bottom-24 right-4 bg-pink-500 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center text-2xl hover:bg-pink-600 active:scale-90 transition z-50">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

        <div x-show="currentTab === 'expenses'" class="p-4 h-full overflow-y-auto no-scrollbar pb-24">
            <div class="bg-gradient-to-r from-green-500 to-teal-500 text-white p-5 rounded-2xl shadow-lg mb-6">
                <div class="text-sm opacity-80 mb-1">總花費 (KRW)</div>
                <div class="text-4xl font-bold mb-2">₩ <span x-text="formatNumber(totalExpenses)"></span></div>
                <div class="text-sm opacity-80 text-right">≈ TWD <span x-text="formatNumber(Math.round(totalExpenses / 42))"></span></div>
            </div>

            <div class="space-y-3 pb-20">
                <template x-for="(expense, index) in expenses" :key="index">
                    <div class="bg-white p-3 rounded-xl shadow-sm flex items-center justify-between border-l-4" :class="getExpenseColor(expense.category)">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center mr-3 text-gray-500">
                                <i :class="getExpenseIcon(expense.category)"></i>
                            </div>
                            <div>
                                <div class="font-bold text-gray-800" x-text="expense.name"></div>
                                <div class="text-xs text-gray-500"><span x-text="expense.date"></span> | <span x-text="expense.payment"></span></div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-gray-800">₩ <span x-text="formatNumber(expense.amount)"></span></div>
                            <button @click="deleteExpense(index)" class="text-xs text-red-400 mt-1">刪除</button>
                        </div>
                    </div>
                </template>
            </div>

            <button @click="openModal('expense')" class="fixed bottom-24 right-4 bg-green-500 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center text-2xl hover:bg-green-600 active:scale-90 transition z-50">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

        <div class="fixed bottom-6 right-4 left-4 z-50">
            <div class="bg-white/95 backdrop-blur rounded-2xl shadow-2xl p-2 flex justify-around items-center border border-gray-200">
                <button @click="currentTab = 'itinerary'" class="flex flex-col items-center w-16 transition duration-200" :class="currentTab === 'itinerary' ? 'text-blue-600 scale-110' : 'text-gray-400'">
                    <i class="fa-solid fa-location-dot text-xl mb-1"></i>
                    <span class="text-[10px] font-bold">行程</span>
                </button>
                <button @click="currentTab = 'info'" class="flex flex-col items-center w-16 transition duration-200" :class="currentTab === 'info' ? 'text-blue-600 scale-110' : 'text-gray-400'">
                    <i class="fa-solid fa-circle-info text-xl mb-1"></i>
                    <span class="text-[10px] font-bold">資訊</span>
                </button>
                <button @click="currentTab = 'shopping'" class="flex flex-col items-center w-16 transition duration-200" :class="currentTab === 'shopping' ? 'text-blue-600 scale-110' : 'text-gray-400'">
                    <i class="fa-solid fa-basket-shopping text-xl mb-1"></i>
                    <span class="text-[10px] font-bold">購物</span>
                </button>
                <button @click="currentTab = 'expenses'" class="flex flex-col items-center w-16 transition duration-200" :class="currentTab === 'expenses' ? 'text-blue-600 scale-110' : 'text-gray-400'">
                    <i class="fa-solid fa-coins text-xl mb-1"></i>
                    <span class="text-[10px] font-bold">花費</span>
                </button>
            </div>
        </div>

        <div x-show="isModalOpen" class="fixed inset-0 bg-black/60 z-[100] flex items-end sm:items-center justify-center" x-transition.opacity>
            <div @click.away="closeModal()" class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-2xl p-6 relative" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="translate-y-full sm:translate-y-10" x-transition:enter-end="translate-y-0">
                <h3 class="text-xl font-bold mb-4 text-gray-800" x-text="modalTitle"></h3>
                
                <div x-show="modalType === 'itinerary'" class="space-y-3">
                    <select x-model="formItinerary.type" class="w-full border bg-gray-50 rounded-lg p-3">
                        <option value="景點">景點</option>
                        <option value="住宿">住宿</option>
                        <option value="美食">美食</option>
                        <option value="購物">購物</option>
                        <option value="flight">航班</option>
                        <option value="其他">其他</option>
                    </select>
                    <input x-model="formItinerary.name" placeholder="名稱 (例: 廣安里)" class="w-full border bg-gray-50 rounded-lg p-3">
                    <input x-model="formItinerary.location" placeholder="導航地點 (主案)" class="w-full border bg-gray-50 rounded-lg p-3">
                    <div class="flex gap-2">
                        <input x-model="formItinerary.startTime" type="time" class="w-1/2 border bg-gray-50 rounded-lg p-3">
                        <input x-model="formItinerary.openTime" placeholder="營業時間" class="w-1/2 border bg-gray-50 rounded-lg p-3">
                    </div>
                    <input x-model="formItinerary.alternativeName" placeholder="備案名稱 (可選)" class="w-full border bg-blue-50 rounded-lg p-3 border-blue-200">
                    <input x-model="formItinerary.alternativeLocation" placeholder="備案導航地點 (可選)" class="w-full border bg-blue-50 rounded-lg p-3 border-blue-200">
                    <textarea x-model="formItinerary.note" placeholder="備註/說明" class="w-full border bg-gray-50 rounded-lg p-3 h-20"></textarea>
                    <div class="flex gap-2 mt-4">
                        <button x-show="isEditMode" @click="confirmDeleteItinerary()" class="flex-1 bg-red-100 text-red-600 py-3 rounded-xl font-bold">刪除</button>
                        <button @click="saveItinerary()" class="flex-[2] bg-blue-600 text-white py-3 rounded-xl font-bold">儲存</button>
                    </div>
                </div>

                <div x-show="modalType === 'shopping'" class="space-y-3">
                    <input x-model="formShopping.name" placeholder="商品名稱" class="w-full border bg-gray-50 rounded-lg p-3">
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:bg-gray-50" @click="$refs.fileInput.click()">
                        <input type="file" x-ref="fileInput" class="hidden" @change="handleImageUpload">
                        <template x-if="formShopping.image">
                            <img :src="formShopping.image" class="h-32 mx-auto object-contain">
                        </template>
                        <template x-if="!formShopping.image">
                            <div class="text-gray-400"><i class="fa-solid fa-camera text-2xl mb-2"></i><br>上傳圖片</div>
                        </template>
                    </div>
                    <button @click="saveShopping()" class="w-full bg-pink-500 text-white py-3 rounded-xl font-bold mt-2">加入</button>
                </div>

                <div x-show="modalType === 'expense'" class="space-y-3">
                    <select x-model="formExpense.category" class="w-full border bg-gray-50 rounded-lg p-3">
                        <option value="飲食">飲食</option>
                        <option value="交通">交通</option>
                        <option value="住宿">住宿</option>
                        <option value="購物">購物</option>
                        <option value="門票">門票</option>
                        <option value="其他">其他</option>
                    </select>
                    <input x-model="formExpense.name" placeholder="項目名稱" class="w-full border bg-gray-50 rounded-lg p-3">
                    <input type="number" x-model="formExpense.amount" placeholder="金額 (KRW)" class="w-full border bg-gray-50 rounded-lg p-3 text-lg">
                    <div class="flex gap-2">
                        <input type="date" x-model="formExpense.date" class="w-1/2 border bg-gray-50 rounded-lg p-3">
                        <select x-model="formExpense.payment" class="w-1/2 border bg-gray-50 rounded-lg p-3">
                            <option value="現金">現金</option>
                            <option value="信用卡">信用卡</option>
                        </select>
                    </div>
                    <button @click="saveExpense()" class="w-full bg-green-500 text-white py-3 rounded-xl font-bold mt-2">記錄</button>
                </div>

                <button @click="closeModal()" class="absolute top-4 right-4 text-gray-400 p-2"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
        </div>

    </div>

    <script>
        function travelApp() {
            return {
                isAppLoaded: false,
                currentTab: 'itinerary',
                selectedDayIndex: 0,
                isModalOpen: false,
                modalType: '',
                modalTitle: '',
                isEditMode: false,
                editingId: null,
                weather: { temp: 6, feelsLike: 2, condition: 'cloudy' }, 
                exchange: { krw: 10000, twd: 238 },
                
                days: [
                    { weekday: 'Wed', date: '25', fullDate: '2025-12-25' },
                    { weekday: 'Thu', date: '26', fullDate: '2025-12-26' },
                    { weekday: 'Fri', date: '27', fullDate: '2025-12-27' }
                ],
                
                itineraries: {
                    0: [
                        { id: 1, type: 'flight', name: 'BX794', location: '金海國際機場', startTime: '13:35', note: 'TPE -> PUS (不可變動)', alternativeName: null, alternativeLocation: null },
                        { id: 2, type: '住宿', name: 'Check-in K-Guesthouse', location: 'K-Guesthouse Seomyeon', startTime: '18:30', note: '西面站 Check-in (不可變動)', alternativeName: null, alternativeLocation: null },
                        { id: 3, type: '美食', name: '味贊王鹽烤肉', location: '味贊王鹽烤肉 西面店', startTime: '19:00', openTime: '11:00-23:00', note: '推薦厚切五花肉', alternativeName: '西面：荒謬的生肉', alternativeLocation: '엉터리생고기 서면점' },
                        { id: 4, type: '景點', name: '廣安里海水浴場', location: '廣安里海水浴場', startTime: '20:30', note: '聖誕夜景與大橋', alternativeName: '西面：三光寺', alternativeLocation: '삼광사 (如果想看佛教燈海)' }
                    ],
                    1: [
                        { id: 5, type: '景點', name: '田浦咖啡街', location: '田浦咖啡街', startTime: '10:30', note: '文青咖啡廳巡禮', alternativeName: '甘川文化村', alternativeLocation: '감천문화마을' },
                        { id: 6, type: '美食', name: '本粥 (午餐)', location: '本粥 西面店', startTime: '12:30', note: '術前清淡飲食 (推薦主案)', alternativeName: 'Isaac Toast', alternativeLocation: '이삭토스트 서면점' },
                        { id: 7, type: '其他', name: '金陽濟皮膚科', location: '고운세상김양제피부과', startTime: '15:00', openTime: '09:30-19:00', note: '醫美：張峰碩院長 (不可變動)', alternativeName: null, alternativeLocation: null },
                        { id: 8, type: '美食', name: '松亭三代豬肉湯飯', location: '松亭三代豬肉湯飯', startTime: '18:00', note: '釜山必吃', alternativeName: '巨人炸雞', alternativeLocation: '거인통닭 (南浦洞市場)' }
                    ],
                    2: [
                        { id: 9, type: '景點', name: '海雲台膠囊列車', location: '海雲台藍線公園尾浦站', startTime: '11:00', ticket: '35000 KRW', note: '已預約膠囊列車 (不可變動)', alternativeName: null, alternativeLocation: null },
                        { id: 10, type: '購物', name: '樂天超市光復店', location: '樂天瑪特 光復店', startTime: '15:00', openTime: '10:30-23:00', note: '零食伴手禮採買', alternativeName: '國際市場', alternativeLocation: '부산 국제시장' },
                        { id: 11, type: 'flight', name: 'IT607', location: '金海國際機場', startTime: '21:35', note: 'PUS -> TPE (不可變動)', alternativeName: null, alternativeLocation: null }
                    ]
                },

                checkList: [
                    { name: '豬肉湯飯 (松亭)', type: 'Food', checked: false },
                    { name: '海雲台魚板 (必買)', type: 'Shopping', checked: false },
                    { name: '辣炒年糕 (路邊攤)', type: 'Food', checked: false },
                    { name: '馬格利酒 (麴醇堂)', type: 'Shopping', checked: false },
                    { name: '씨앗호떡 (糖餅)', type: 'Food', checked: false },
                    { name: 'Maximus 金屬線髮夾', type: 'Shopping', checked: false },
                ],

                shoppingList: [
                    { name: 'Olive Young 面膜', image: null },
                    { name: 'HBAF 杏仁果', image: null }
                ],

                expenses: [],
                totalExpenses: 0,
                formItinerary: {},
                formShopping: { name: '', image: null },
                formExpense: { category: '飲食', name: '', amount: '', date: '2025-12-25', payment: '現金' },

                get currentDayItinerary() {
                    return this.itineraries[this.selectedDayIndex] || [];
                },

                // 移除不穩定的 SortableJS 載入，僅保留 App 狀態
                initApp() {
                    this.$nextTick(() => {
                        setTimeout(() => { this.isAppLoaded = true; }, 100); 
                    });
                },

                openModal(type) {
                    this.modalType = type;
                    this.isModalOpen = true;
                    if (type === 'itinerary') {
                        this.isEditMode = false;
                        this.modalTitle = '新增行程';
                        this.formItinerary = { type: '景點', name: '', location: '', startTime: '', openTime: '', ticket: '', note: '', alternativeName: '', alternativeLocation: '' };
                    } else if (type === 'shopping') {
                        this.modalTitle = '新增購物';
                        this.formShopping = { name: '', image: null };
                    } else if (type === 'expense') {
                        this.modalTitle = '記錄花費';
                        this.formExpense.date = this.days[this.selectedDayIndex].fullDate;
                    }
                },
                closeModal() { this.isModalOpen = false; },

                editItem(item) {
                    this.modalType = 'itinerary';
                    this.modalTitle = '編輯行程';
                    this.isEditMode = true;
                    this.editingId = item.id;
                    this.formItinerary = { 
                        ...item, 
                        alternativeName: item.alternativeName || '',
                        alternativeLocation: item.alternativeLocation || ''
                    };
                    this.isModalOpen = true;
                },
                saveItinerary() {
                    if (this.formItinerary.alternativeName === '') delete this.formItinerary.alternativeName;
                    if (this.formItinerary.alternativeLocation === '') delete this.formItinerary.alternativeLocation;
                    
                    if (this.isEditMode) {
                        let items = this.itineraries[this.selectedDayIndex];
                        let index = items.findIndex(i => i.id === this.editingId);
                        if (index !== -1) items[index] = { ...this.formItinerary, id: this.editingId };
                    } else {
                        if (!this.itineraries[this.selectedDayIndex]) this.itineraries[this.selectedDayIndex] = [];
                        this.itineraries[this.selectedDayIndex].push({ ...this.formItinerary, id: Date.now() });
                    }
                    this.closeModal();
                },
                confirmDeleteItinerary() {
                    if (confirm('確定刪除？')) {
                        let items = this.itineraries[this.selectedDayIndex];
                        this.itineraries[this.selectedDayIndex] = items.filter(i => i.id !== this.editingId);
                        this.closeModal();
                    }
                },
                openMap(location) {
                    if(location) {
                        // 使用 Google Map 搜尋連結
                        const url = 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(location);
                        window.open(url, '_blank');
                    }
                },
                
                handleImageUpload(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => { this.formShopping.image = e.target.result; };
                        reader.readAsDataURL(file);
                    }
                },
                saveShopping() {
                    if (this.formShopping.name) {
                        this.shoppingList.push({ ...this.formShopping });
                        this.closeModal();
                    }
                },
                deleteShoppingItem(index) {
                    if(confirm('刪除商品？')) this.shoppingList.splice(index, 1);
                },

                saveExpense() {
                    if (this.formExpense.amount) {
                        this.expenses.push({ ...this.formExpense });
                        this.totalExpenses += parseInt(this.formExpense.amount);
                        this.closeModal();
                    }
                },
                deleteExpense(index) {
                    if(confirm('刪除記錄？')) {
                        this.totalExpenses -= parseInt(this.expenses[index].amount);
                        this.expenses.splice(index, 1);
                    }
                },

                calculateTWD() { this.exchange.twd = Math.round(this.exchange.krw / 42); },
                calculateKRW() { this.exchange.krw = Math.round(this.exchange.twd * 42); },
                formatNumber(num) { return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); },
                getCategoryColor(type) {
                    const colors = { '景點':'bg-blue-500', '住宿':'bg-indigo-500', '美食':'bg-orange-500', '購物':'bg-pink-500', 'flight':'bg-purple-600', '交通':'bg-green-500', '其他':'bg-gray-500' };
                    return colors[type] || 'bg-gray-500';
                },
                getExpenseColor(cat) {
                    const c = { '飲食':'border-orange-400', '交通':'border-green-400', '住宿':'border-indigo-400', '購物':'border-pink-400', '門票':'border-blue-400' };
                    return c[cat] || 'border-gray-400';
                },
                getExpenseIcon(cat) {
                    const i = { '飲食':'fa-utensils', '交通':'fa-bus', '住宿':'fa-bed', '購物':'fa-bag-shopping', '門票':'fa-ticket' };
                    return 'fa-solid ' + (i[cat] || 'fa-won-sign');
                },
                getWeatherIcon() {
                    return '<i class="fa-solid fa-cloud text-gray-200"></i>';
                }
            }
        }
    </script>
</body>
</html>